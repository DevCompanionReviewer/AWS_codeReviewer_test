name: Notify API on PR Open

on:
  pull_request:
    types:
      - opened

jobs:
  notify_api:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the code
        uses: actions/checkout@v2

      - name: Install ngrok
        run: |
          wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip
          chmod +x ngrok
          sudo mv ngrok /usr/local/bin/ngrok
          rm ngrok-stable-linux-amd64.zip

      - name: Start ngrok
        run: |
          ngrok http 4043 &  # Use & to run ngrok in the background
          sleep 3  # Wait a few seconds for ngrok to start

      - name: Get Public URL
        id: ngrok
        run: |
          public_url=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          echo "Public URL: $public_url"
          echo "::set-output name=public_url::$public_url"

      - name: Get PR Information
        run: |
          pr_number="${{ github.event.pull_request.number }}"
          repo_name="${{ github.repository }}"
          repo_owner=$(echo $repo_name | cut -d'/' -f1)
          repo_name=$(echo $repo_name | cut -d'/' -f2)
          files=$(git diff --name-only "refs/pull/$pr_number/head")

          echo "PR Number: $pr_number"
          echo "Repository Owner: $repo_owner"
          echo "Repository Name: $repo_name"
          echo "Changed Files: $files"
          
          files_csv=$(echo "$files" | tr '\n' ',' | sed 's/,$//')


          # Call your API with the PR information and the ngrok public URL
          api_url="$public_url/startReview"
          github_token="${{ secrets.MY_GITHUB_TOKEN }}"
          curl -X POST -H "Content-Type: application/json" -d '{
              "prId": "'$pr_number'",
              "files": "'$files_csv'",
              "githubToken": "'$github_token'"
          }' $api_url

        env:
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
